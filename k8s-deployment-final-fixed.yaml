apiVersion: apps/v1
kind: Deployment
metadata:
  name: opensign-mongo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opensign-mongo
  template:
    metadata:
      labels:
        app: opensign-mongo
    spec:
      containers:
      - name: mongo
        image: mongo:6.0
        ports:
        - containerPort: 27017
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          value: "admin"
        - name: MONGO_INITDB_ROOT_PASSWORD
          value: "password"
        volumeMounts:
        - name: mongo-storage
          mountPath: /data/db
      volumes:
      - name: mongo-storage
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: opensign-mongo-service
spec:
  selector:
    app: opensign-mongo
  ports:
    - protocol: TCP
      port: 27017
      targetPort: 27017
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opensign-backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: opensign-backend
  template:
    metadata:
      labels:
        app: opensign-backend
    spec:
      containers:
      - name: backend
        image: gcr.io/esign-alpha-474811/opensign-backend:latest
        ports:
        - containerPort: 8081
        env:
        - name: APP_ID
          value: "opensign"
        - name: SERVER_URL
          value: "http://opensign-backend-service:8081/app"
        - name: MASTER_KEY
          value: "XnAadwKxxByMr1234567890abcdefg"  # Fixed master key for demo
        - name: DATABASE_URI
          value: "mongodb://admin:password@opensign-mongo-service:27017/opensign?authSource=admin"
        - name: PORT
          value: "8081"
        - name: USE_LOCAL
          value: "true"
        - name: SMTP_ENABLE
          value: "true"
        - name: SMTP_HOST
          value: "smtp.gmail.com"
        - name: SMTP_PORT
          value: "587"
        - name: SMTP_USER_EMAIL
          value: "vatgcbs15@gmail.com"
        - name: SMTP_PASS
          value: "eacb ytol wvvz nzcu"
        - name: SMTP_FROM_NAME
          value: "OpenSign"
        - name: SMTP_REPLY_TO_EMAIL
          value: "vatgcbs15@gmail.com"
        volumeMounts:
        - name: backend-logs
          mountPath: /app/logs
      volumes:
      - name: backend-logs
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: opensign-backend-service
spec:
  selector:
    app: opensign-backend
  ports:
    - protocol: TCP
      port: 8081
      targetPort: 8081
  type: ClusterIP

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opensign-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: opensign-frontend
  template:
    metadata:
      labels:
        app: opensign-frontend
    spec:
      containers:
      - name: frontend
        image: gcr.io/esign-alpha-474811/opensign-frontend:latest
        ports:
        - containerPort: 80
        env:
        - name: REACT_APP_SERVERURL
          value: "http://opensign-backend-service:8081/app"
        - name: REACT_APP_APPID
          value: "opensign"
        command: ["/bin/sh", "-c"]
        args:
        - |
          # Remove the default nginx configuration that conflicts with our SPA routing
          rm -f /etc/nginx/conf.d/default.conf
          # Create a new nginx configuration with proper SPA routing
          cat > /etc/nginx/nginx.conf << 'EOF'
          events {
              worker_connections 1024;
          }

          http {
              include       /etc/nginx/mime.types;
              default_type  application/octet-stream;

              # Log format
              log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for"';

              access_log  /var/log/nginx/access.log  main;
              error_log   /var/log/nginx/error.log;

              sendfile        on;
              tcp_nopush      on;
              tcp_nodelay     on;
              keepalive_timeout  65;
              types_hash_max_size 2048;

              # Include MIME types
              include /etc/nginx/conf.d/*.conf;

              # Server block
              server {
                  listen       80;
                  server_name  _;

                  # Serve static files with proper SPA routing
                  location / {
                      root   /usr/share/nginx/html;
                      index  index.html index.htm;
                      try_files $uri $uri/ /index.html;
                  }

                  # Proxy API requests to backend
                  location /app {
                      proxy_pass http://opensign-backend-service:8081/app;
                      proxy_http_version 1.1;
                      proxy_set_header Upgrade $http_upgrade;
                      proxy_set_header Connection 'upgrade';
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto $scheme;
                      proxy_cache_bypass $http_upgrade;
                  }

                  # Error pages
                  error_page   500 502 503 504  /50x.html;
                  location = /50x.html {
                      root   /usr/share/nginx/html;
                  }
              }
          }
          EOF
          nginx -g 'daemon off;'
---
apiVersion: v1
kind: Service
metadata:
  name: opensign-frontend-service
spec:
  selector:
    app: opensign-frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
  type: LoadBalancer